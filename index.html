<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TELECOM ADMIN - CENTRALIZADO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; }
        * { box-sizing: border-box; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* TELA DE LOGIN */
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; }

        /* NAVBAR */
        .navbar { background: var(--primary); padding: 10px; display: flex; overflow-x: auto; gap: 8px; border-bottom: 2px solid var(--accent); }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 12px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .nav-btn.active { background: var(--accent); }

        .content { flex: 1; padding: 15px; overflow-y: auto; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* CARDS */
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 16px; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: #10b981; }
        .btn-cam { background: #f59e0b; margin-bottom: 10px; }

        /* CAMERA */
        #reader { width: 100%; border-radius: 10px; margin-bottom: 10px; overflow: hidden; display: none; border: 3px solid var(--accent); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="margin-top:0;">Admin Telecom</h2>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn btn-blue" onclick="fazerLogin()">ACESSAR SISTEMA</button>
        </div>
    </div>

    <div id="app-container" style="display:none; flex-direction:column; height:100%;">
        <div class="navbar">
            <button class="nav-btn active" onclick="nav('entrada')">üì• Entrada</button>
            <button class="nav-btn" onclick="nav('saida')">üì§ Sa√≠da T√©cnico</button>
            <button class="nav-btn" onclick="nav('os')">üìã O.S.</button>
            <button class="nav-btn" onclick="nav('config')">‚öôÔ∏è Config C√≥digos</button>
            <button class="nav-btn" onclick="logout()" style="color:#fca5a5;">Sair</button>
        </div>

        <div class="content">
            <div id="reader"></div>

            <div id="view-entrada" class="view-section active">
                <div class="card">
                    <h3>Receber Material (Entrada)</h3>
                    <button class="btn btn-cam" onclick="abrirCamera('in')">üì∑ LER C√ìDIGO DE BARRAS</button>
                    <label>Cabo (Metros)</label><input type="number" id="in-cabo" value="0">
                    <label>Roteadores</label><input type="number" id="in-rot" value="0">
                    <button class="btn btn-green" onclick="salvarEntrada()">SALVAR E GERAR PDF</button>
                </div>
            </div>

            <div id="view-saida" class="view-section">
                <div class="card">
                    <h3>Sa√≠da para T√©cnico</h3>
                    <label>Selecione o Instalador</label>
                    <select id="sel-tecnico"></select>
                    <button class="btn btn-cam" onclick="abrirCamera('out')">üì∑ BIPAR PARA CARRO</button>
                    <label>Cabo (m)</label><input type="number" id="out-cabo" value="0">
                    <label>Roteadores</label><input type="number" id="out-rot" value="0">
                    <button class="btn btn-blue" onclick="salvarSaida()">TRANSFERIR MATERIAL</button>
                </div>
            </div>

            <div id="view-os" class="view-section">
                <div class="card">
                    <h3>Gest√£o de O.S.</h3>
                    <input type="text" id="os-cliente" placeholder="Nome do Cliente">
                    <input type="text" id="os-servico" placeholder="Servi√ßo">
                    <select id="os-sel-tecnico"></select>
                    <button class="btn btn-blue" onclick="criarOS()">CRIAR O.S.</button>
                </div>
                <div id="lista-os"></div>
            </div>

            <div id="view-config" class="view-section">
                <div class="card">
                    <h3>Cadastrar C√≥digos de Barras</h3>
                    <button class="btn btn-cam" onclick="abrirCamera('cfg')">üì∑ LER PRODUTO NOVO</button>
                    <input type="text" id="cfg-codigo" placeholder="C√≥digo Lido">
                    <select id="cfg-tipo">
                        <option value="rot">Roteador</option>
                        <option value="cabo">Cabo (300m)</option>
                    </select>
                    <button class="btn btn-blue" onclick="salvarCodigo()">SALVAR MAPA</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- SUAS CHAVES J√Å CONFIGURADAS ---
    const firebaseConfig = {
        apiKey: "AIzaSyBS8t51QON29MIYDkkcZETchdevHFVMzCk",
        authDomain: "internet-f2434.firebaseapp.com",
        databaseURL: "https://internet-f2434-default-rtdb.firebaseio.com",
        projectId: "internet-f2434",
        storageBucket: "internet-f2434.firebasestorage.app",
        messagingSenderId: "506788174813",
        appId: "1:506788174813:web:50e05b1a194d70f412b434"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // LOGIN
    function fazerLogin() {
        const email = document.getElementById('email').value;
        const senha = document.getElementById('senha').value;
        auth.signInWithEmailAndPassword(email, senha).catch(e => alert("Erro ao entrar: " + e.message));
    }
    function logout() { auth.signOut(); location.reload(); }
    
    auth.onAuthStateChanged(user => {
        if(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            iniciarApp();
        }
    });

    function nav(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        event.target.classList.add('active');
        if(scanner) scanner.stop();
    }

    // C√ÇMERA
    let scanner;
    let modoGlobal = '';
    let mapaCodigos = {};

    function abrirCamera(modo) {
        modoGlobal = modo;
        document.getElementById('reader').style.display = 'block';
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
            if(modoGlobal === 'cfg') {
                document.getElementById('cfg-codigo').value = text;
                scanner.stop();
            } else {
                const tipo = mapaCodigos[text];
                if(tipo) {
                    const campo = document.getElementById(`${modoGlobal}-${tipo}`);
                    campo.value = parseInt(campo.value) + (tipo === 'cabo' ? 300 : 1);
                    tocarBip();
                }
            }
        });
    }

    // SISTEMA
    function iniciarApp() {
        db.ref('codigos').on('value', s => mapaCodigos = s.val() || {});
        
        db.ref('tecnicos').on('value', s => {
            const t = s.val() || {};
            const sels = [document.getElementById('sel-tecnico'), document.getElementById('os-sel-tecnico')];
            sels.forEach(sel => {
                sel.innerHTML = '<option value="">Escolha o T√©cnico...</option>';
                Object.keys(t).forEach(k => sel.innerHTML += `<option value="${k}">${t[k].nome}</option>`);
            });
        });

        db.ref('os').on('value', s => {
            const lista = document.getElementById('lista-os');
            lista.innerHTML = '';
            const dados = s.val() || {};
            Object.keys(dados).forEach(id => {
                lista.innerHTML += `<div class="card"><b>${dados[id].cliente}</b><br>${dados[id].servico}</div>`;
            });
        });
    }

    function salvarEntrada() {
        const c = +document.getElementById('in-cabo').value;
        const r = +document.getElementById('in-rot').value;
        db.ref('estoque_central').transaction(d => {
            if(!d) d = {cabo:0, rot:0};
            d.cabo += c; d.rot += r;
            return d;
        });
        alert("Salvo com sucesso!");
    }

    function salvarSaida() {
        const tec = document.getElementById('sel-tecnico').value;
        if(!tec) return alert("Selecione um t√©cnico");
        const c = +document.getElementById('out-cabo').value;
        const r = +document.getElementById('out-rot').value;
        
        db.ref('estoque_volante/'+tec).transaction(d => {
            if(!d) d = {cabo:0, rot:0};
            d.cabo += c; d.rot += r;
            return d;
        });
        alert("Material transferido para o t√©cnico!");
    }

    function criarOS() {
        db.ref('os').push({
            cliente: document.getElementById('os-cliente').value,
            servico: document.getElementById('os-servico').value,
            tec: document.getElementById('os-sel-tecnico').value,
            status: 'pendente'
        });
        alert("O.S. Criada!");
    }

    function salvarCodigo() {
        const cod = document.getElementById('cfg-codigo').value;
        const tipo = document.getElementById('cfg-tipo').value;
        db.ref('codigos/'+cod).set(tipo);
        alert("Produto Mapeado!");
    }

    function tocarBip() {
        const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain();
        o.connect(g); g.connect(a.destination); o.frequency.value = 1200; g.gain.value = 0.1; o.start(); setTimeout(()=>o.stop(), 100);
    }
</script>
</body>
</html>
