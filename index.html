<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WV SERVIÃ‡OS - V6.1</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #6366f1; --bg: #f1f5f9; --card-bg: #ffffff; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --text-main: #334155; --text-muted: #64748b; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .navbar { background: var(--primary); display: flex; overflow-x: auto; padding: 0 10px; gap: 10px; border-bottom: 4px solid var(--accent); align-items: center; scrollbar-width: none; flex-shrink: 0; }
        .nav-btn { background: transparent; border: none; color: #94a3b8; padding: 15px 10px; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 11px; text-transform: uppercase; }
        .nav-btn.active { color: white; border-bottom: 3px solid white; }
        .content { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; position: relative; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; margin-bottom: 8px; box-sizing: border-box; background: #f8fafc; }
        label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; display: block; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; margin-top: 5px; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-orange { background: var(--warning); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-delete { color: var(--danger); background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; }
        .scanned-display { background: #e0f2fe; color: #0369a1; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; margin: 10px 0; display: none; }
        .os-info-grid { display: grid; grid-template-columns: 1fr; gap: 3px; margin-top: 10px; font-size: 12px; }
        .os-info-item b { color: var(--text-muted); font-size: 10px; text-transform: uppercase; margin-right: 5px; }
        #footer { background: var(--primary); color: #94a3b8; padding: 15px; text-align: center; font-size: 10px; border-top: 2px solid var(--accent); flex-shrink: 0; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .os-item { border-left: 6px solid #cbd5e1; }
        .os-item.pendente { border-color: var(--warning); }
        .os-item.concluido { border-color: var(--success); }
        #reader { width: 100%; max-width: 400px; margin: 0 auto 20px; border-radius: 16px; overflow: hidden; display: none; border: 3px solid var(--accent); }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background:var(--primary); z-index:9999; display:flex; align-items:center; justify-content:center;">
        <div class="card" style="width:90%; max-width:350px; text-align:center;">
            <h3>WV SERVIÃ‡OS</h3>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn btn-blue" onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>

    <div id="app-container" style="display:none; flex-direction:column; height:100%;">
        <nav class="navbar">
            <button class="nav-btn active" onclick="nav('os')">ğŸ“‹ O.S.</button>
            <button class="nav-btn" onclick="nav('estoque')">ğŸ“¦ Estoque</button>
            <button class="nav-btn" onclick="nav('entrada')">ğŸ“¥ Entrada</button>
            <button class="nav-btn" onclick="nav('saida')">ğŸ“¤ SaÃ­da</button>
            <button class="nav-btn" onclick="nav('financeiro')">ğŸ’° Fin.</button>
            <button class="nav-btn" onclick="nav('backup')">ğŸ’¾ Backup</button>
            <button class="nav-btn" onclick="nav('admin')">âš™ï¸ ADM</button>
            <button class="nav-btn" onclick="fazerLogout()" style="color:var(--danger)">ğŸšª SAIR</button>
        </nav>

        <div class="content" id="main-content">
            <div id="reader"></div>

            <div id="view-os" class="view-section active">
                <div class="card">
                    <h3>ğŸ“‹ Nova O.S.</h3>
                    <input type="hidden" id="os-edit-id">
                    <div style="display:flex; gap:5px;"><div style="flex:1;"><label>NÂº O.S.</label><input type="text" id="os-numero"></div><div style="flex:1;"><label>Data</label><input type="date" id="os-data-manual"></div></div>
                    <label>Cliente</label><input type="text" id="os-cliente">
                    <label>Telefone</label><input type="tel" id="os-telefone">
                    <div style="display:flex; gap:5px;"><div style="flex:2;"><label>CEP</label><input type="text" id="os-cep" onblur="buscarCep()"></div><div style="flex:1;"><label>NÂº Casa</label><input type="text" id="os-numero-casa"></div></div>
                    <div style="display:flex; gap:5px;"><div style="flex:1;"><label>Bairro</label><input type="text" id="os-bairro"></div><div style="flex:1;"><label>Cidade</label><input type="text" id="os-cidade"></div></div>
                    <label>Rua</label><input type="text" id="os-endereco">
                    <label>TÃ©cnico</label><select id="os-tecnico"></select>
                    <label>ServiÃ§o</label><select id="os-servico-select"></select>
                    <label>Valor MÃ£o de Obra</label><input type="number" id="os-valor-pagar">
                    <button class="btn btn-blue" onclick="criarOS()">SALVAR O.S.</button>
                </div>
                <div id="lista-os"></div>
            </div>

            <div id="view-estoque" class="view-section">
                <div class="card"><h3>ğŸ¢ Estoque Central</h3><div id="lista-estoque-central"></div><button class="btn btn-red" onclick="abrirModalAjuste('descarte')">ğŸ—‘ï¸ DESCARTAR MATERIAL</button></div>
                <div class="card"><h3>ğŸšš Mala do TÃ©cnico</h3><select id="filtro-tecnico-estoque" onchange="carregarEstoqueVolante(this.value)"></select><div id="lista-estoque-volante"></div><button class="btn btn-orange" onclick="abrirModalAjuste('devolucao')">â†©ï¸ DEVOLVER PARA CENTRAL</button></div>
            </div>

            <div id="view-entrada" class="view-section"><div class="card"><h3>ğŸ“¥ Entrada</h3><button class="btn btn-orange" onclick="abrirCamera('in')">ğŸ“· BIPAR</button><div id="display-in" class="scanned-display"></div><select id="in-produto"></select><input type="number" id="in-qtd" value="1"><button class="btn btn-green" onclick="processarEntrada()">CONFIRMAR</button></div></div>
            
            <div id="view-saida" class="view-section"><div class="card"><h3>ğŸ“¤ SaÃ­da</h3><select id="out-tecnico"></select><button class="btn btn-orange" onclick="abrirCamera('out')">ğŸ“· BIPAR</button><div id="display-out" class="scanned-display"></div><select id="out-produto"></select><input type="number" id="out-qtd" value="1"><button class="btn btn-blue" onclick="processarSaida()">TRANSFERIR</button></div></div>

            <div id="view-financeiro" class="view-section"><div class="card"><h3>ğŸ’° Financeiro</h3><select id="fin-filtro-tecnico" onchange="listarFinanceiroTecnico(this.value)"></select><div id="detalhes-financeiro"></div></div></div>

            <div id="view-backup" class="view-section"><div class="card"><h3>ğŸ’¾ Backup</h3><button class="btn btn-blue" onclick="exportarBackup()">ğŸ“¥ EXPORTAR</button><hr><input type="file" id="import-file" accept=".json"><button class="btn btn-red" onclick="importarBackup()">ğŸ“¤ RESTAURAR</button></div></div>

            <div id="view-admin" class="view-section">
                <div class="card">
                    <h3>ğŸ“¦ Novo Produto</h3>
                    <button class="btn btn-orange" onclick="abrirCamera('cad')">ğŸ“· SCANNER</button>
                    <div id="display-cad" class="scanned-display"></div>
                    <input type="text" id="cad-item-nome" placeholder="Nome">
                    <input type="text" id="cad-item-barcode" placeholder="Barcode">
                    <button class="btn btn-green" onclick="cadastrarItem()">SALVAR</button>
                    <hr>
                    <h4>Produtos Cadastrados (Lixeira)</h4>
                    <div id="lista-produtos-cadastrados"></div>
                </div>
                <div class="card"><h3>ğŸ‘¤ TÃ©cnicos</h3><input type="text" id="cad-tec-nome" placeholder="Nome"><input type="text" id="cad-tec-id" placeholder="ID"><button class="btn btn-blue" onclick="cadastrarTecnico()">CADASTRAR</button><div id="lista-tecnicos-admin"></div></div>
                <div class="card"><h3>ğŸ“œ Log de Envios</h3><div id="log-movimentacoes" style="font-size:11px;"></div></div>
            </div>
        </div>

        <footer id="footer">
            <b>WV SERVIÃ‡OS E MANUTENCOES LTDA</b><br>
            Rua Sl05, 43 - JardinÃ³polis - SP | <b>VersÃ£o 6.1</b>
        </footer>
    </div>

    <div id="modal-ajuste" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:10000; align-items:center; justify-content:center; padding:20px;"><div class="card" style="width:100%; max-width:400px;"><h3 id="ajuste-titulo">Ajuste</h3><select id="ajuste-produto"></select><input type="number" id="ajuste-qtd"><textarea id="ajuste-motivo" placeholder="Motivo"></textarea><input type="password" id="ajuste-senha" placeholder="Senha 1503"><button class="btn btn-blue" onclick="confirmarAjuste()">CONFIRMAR</button><button class="btn" onclick="fecharModalAjuste()">FECHAR</button></div></div>
    <div id="modal-baixa" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; z-index:10001; align-items:center; justify-content:center; padding:20px;"><div class="card" style="width:100%; max-width:400px;"><h3>Baixar O.S.</h3><div id="baixa-itens-container"></div><button class="btn" onclick="adicionarLinhaBaixa()">+ MATERIAL</button><input type="number" id="baixa-valor-final"><button class="btn btn-green" onclick="confirmarBaixa()">FINALIZAR</button><button class="btn" onclick="fecharModalBaixa()">VOLTAR</button></div></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBS8t51QON29MIYDkkcZETchdevHFVMzCk", authDomain: "internet-f2434.firebaseapp.com", databaseURL: "https://internet-f2434-default-rtdb.firebaseio.com", projectId: "internet-f2434", storageBucket: "internet-f2434.firebasestorage.app", messagingSenderId: "506788174813", appId: "1:506788174813:web:50e05b1a194d70f412b434" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const SENHA_PADRAO = "1503";

    let cacheDadosOS = {}, itensCadastrados = {}, listaTecnicos = {}, mapaBarcodes = {}, scanner, modoAjuste = '', osParaBaixar = null;

    function fazerLogin() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('senha').value); }
    function fazerLogout() { auth.signOut().then(() => location.reload()); }
    auth.onAuthStateChanged(user => { if(user) { document.getElementById('login-screen').style.display='none'; document.getElementById('app-container').style.display='flex'; carregarTudo(); } });

    function carregarTudo() {
        db.ref('itens').on('value', s => { 
            itensCadastrados = s.val() || {}; mapaBarcodes = {};
            let hl = '<table style="width:100%; font-size:13px;">';
            Object.keys(itensCadastrados).forEach(k => {
                if(itensCadastrados[k].barcode) mapaBarcodes[itensCadastrados[k].barcode] = k;
                hl += `<tr style="border-bottom:1px solid #eee;"><td style="padding:8px;">${itensCadastrados[k].nome}</td><td style="text-align:right;"><button onclick="apagar('itens/${k}')" class="btn-delete">ğŸ—‘ï¸</button></td></tr>`;
            });
            document.getElementById('lista-produtos-cadastrados').innerHTML = hl + '</table>';
            
            const opt = Object.keys(itensCadastrados).map(k => `<option value="${k}">${itensCadastrados[k].nome}</option>`).join('');
            ['in-produto', 'out-produto', 'ajuste-produto'].forEach(id => document.getElementById(id).innerHTML = opt);
            
            let hc = '<table>'; Object.keys(itensCadastrados).forEach(k => { hc += `<tr><td>${itensCadastrados[k].nome}</td><td style="text-align:right"><b>${itensCadastrados[k].estoque_central || 0}</b></td></tr>`; });
            document.getElementById('lista-estoque-central').innerHTML = hc + '</table>';
        });

        db.ref('tecnicos').on('value', s => {
            listaTecnicos = s.val() || {};
            const ativos = Object.keys(listaTecnicos).filter(k => listaTecnicos[k].status !== 'inativo');
            document.getElementById('os-tecnico').innerHTML = ativos.map(k => `<option value="${k}">${listaTecnicos[k].nome}</option>`).join('');
            ['out-tecnico', 'filtro-tecnico-estoque', 'fin-filtro-tecnico'].forEach(id => document.getElementById(id).innerHTML = Object.keys(listaTecnicos).map(k => `<option value="${k}">${listaTecnicos[k].nome}</option>`).join(''));
            let ha = ''; Object.keys(listaTecnicos).forEach(k => {
                ha += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>${listaTecnicos[k].nome}</span><button onclick="inativarTecnico('${k}')" style="color:red; border:none; background:none;">â›”</button></div>`;
            });
            document.getElementById('lista-tecnicos-admin').innerHTML = ha;
        });

        db.ref('movimentacoes').limitToLast(15).on('value', s => {
            const logs = s.val() || {}; let h = '';
            Object.keys(logs).reverse().forEach(k => h += `<div style="padding:4px; border-bottom:1px solid #eee;">${logs[k].data}: ${logs[k].msg}</div>`);
            document.getElementById('log-movimentacoes').innerHTML = h;
        });

        db.ref('os').on('value', s => { cacheDadosOS = s.val() || {}; renderizarListaOS(); });
    }

    function registrarLog(msg) { db.ref('movimentacoes').push({ data: new Date().toLocaleString('pt-BR'), msg: msg }); }

    function processarSaida() {
        const tecId = document.getElementById('out-tecnico').value, id = document.getElementById('out-produto').value, q = parseFloat(document.getElementById('out-qtd').value);
        if(tecId && id && q) {
            db.ref(`itens/${id}/estoque_central`).transaction(a => (a||0) - q);
            db.ref(`estoque_volante/${tecId}/${itensCadastrados[id].nome}`).transaction(a => (a||0) + q);
            registrarLog(`SAÃDA: ${q}x ${itensCadastrados[id].nome} p/ ${listaTecnicos[tecId].nome}`);
            alert("OK!");
        }
    }

    function carregarEstoqueVolante(id) {
        db.ref(`estoque_volante/${id}`).on('value', s => {
            const it = s.val() || {}; let h = '';
            Object.keys(it).forEach(n => { if(it[n] > 0) h += `<div class="card" style="padding:10px; margin-bottom:5px; display:flex; justify-content:space-between;"><span>${n}</span><b>${it[n]}</b></div>`; });
            document.getElementById('lista-estoque-volante').innerHTML = h;
        });
    }

    function inativarTecnico(id) {
        if(prompt("Senha 1503 para INATIVAR:") === SENHA_PADRAO) {
            db.ref(`estoque_volante/${id}`).once('value', s => {
                const it = s.val() || {}; Object.keys(it).forEach(n => {
                    const q = it[n]; Object.keys(itensCadastrados).forEach(k => { if(itensCadastrados[k].nome === n) db.ref(`itens/${k}/estoque_central`).transaction(a => (a||0) + q); });
                });
                db.ref(`tecnicos/${id}`).update({ status: 'inativo' }); db.ref(`estoque_volante/${id}`).remove();
                registrarLog(`TÃ‰CNICO INATIVADO: ${listaTecnicos[id].nome}`);
            });
        }
    }

    function renderizarListaOS() {
        const lista = document.getElementById('lista-os'); lista.innerHTML = '';
        Object.keys(cacheDadosOS).reverse().forEach(id => {
            const o = cacheDadosOS[id];
            lista.innerHTML += `<div class="card os-item ${o.status}">
                <b>${o.cliente}</b>
                <div class="os-info-grid">
                    <div><b>OS:</b> ${o.os_numero} | <b>Tel:</b> ${o.telefone}</div>
                    <div><b>Rua:</b> ${o.endereco}, ${o.numero_casa} | <b>Bairro:</b> ${o.bairro}</div>
                    <div><b>TÃ©c:</b> ${o.tecnico_nome}</div>
                </div>
                ${o.status === 'pendente' ? `<button class="btn btn-green" onclick="abrirModalBaixa('${id}',${o.valor_pagar})">BAIXAR</button>` : `<button class="btn btn-blue" onclick="gerarPDFOS('${id}')">PDF</button>`}
            </div>`;
        });
    }

    function apagar(path) { if(prompt("Senha 1503 para EXCLUIR:") === SENHA_PADRAO) db.ref(path).remove(); }
    function nav(id) { document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); }
    function abrirCamera(m) { document.getElementById('reader').style.display='block'; scanner = new Html5Qrcode("reader"); scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (t) => { scanner.stop(); document.getElementById('reader').style.display='none'; document.getElementById('display-'+m).innerText = "Lido: " + t; if(m==='cad') document.getElementById('cad-item-barcode').value = t; else { const k = mapaBarcodes[t]; if(k) document.getElementById(m+'-produto').value = k; } }); }
    function exportarBackup() { db.ref().once('value', s => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(s.val())], {type:'application/json'})); a.download = 'backup.json'; a.click(); }); }
    function importarBackup() { const f = document.getElementById('import-file').files[0]; const r = new FileReader(); r.onload = e => db.ref().set(JSON.parse(e.target.result)); r.readAsText(f); }
</script>
</body>
</html>
