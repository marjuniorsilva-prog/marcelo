<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> WV SERVICOS</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --bg: #f8fafc; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: #1e293b; display: flex; flex-direction: column; height: 100vh; }
        
        #login-screen { position: fixed; inset: 0; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .card-login { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }

        .navbar { background: var(--primary); display: flex; overflow-x: auto; padding: 5px; gap: 5px; border-bottom: 3px solid var(--accent); }
        .nav-btn { background: transparent; border: none; color: #94a3b8; padding: 12px 15px; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 11px; }
        .nav-btn.active { color: white; border-bottom: 2px solid white; }

        .content { flex: 1; padding: 15px; overflow-y: auto; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; border: 1px solid #e2e8f0; position: relative; }
        h3 { margin: 0 0 12px 0; font-size: 15px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; margin-bottom: 8px; box-sizing: border-box; }
        label { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 3px; display: block; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 13px; margin-top: 5px; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-orange { background: #f59e0b; color: white; }
        .btn-delete { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 16px; padding: 5px; }
        .btn-edit { background: none; border: none; color: var(--warning); cursor: pointer; font-size: 16px; padding: 5px; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; padding: 8px; background: #f1f5f9; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; }

        .os-item { border-left: 5px solid #cbd5e1; padding-left: 10px; margin-bottom: 10px; }
        .os-item.pendente { border-color: #f59e0b; }
        .os-item.concluido { border-color: var(--success); }
        .os-info-box { font-size: 13px; margin-bottom: 5px; }
        .badge-tec { background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }

        #modal-baixa { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 5000; padding: 20px; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 12px; padding: 20px; max-height: 85vh; overflow-y: auto; }
        #reader { width: 100%; height: 250px; display: none; border-radius: 10px; overflow: hidden; margin-bottom: 15px; border: 3px solid #f59e0b; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card-login">
            <h2 style="color:var(--primary); margin:0 0 20px 0;">TELECOM ERP</h2>
            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn btn-blue" onclick="fazerLogin()">ENTRAR</button>
        </div>
    </div>

    <div id="app-container" style="display:none; flex-direction:column; height:100%;">
        <nav class="navbar">
            <button class="nav-btn active" onclick="nav('estoque')">üì¶ ESTOQUE</button>
            <button class="nav-btn" onclick="nav('entrada')">üì• ENTRADA</button>
            <button class="nav-btn" onclick="nav('saida')">üì§ SA√çDA</button>
            <button class="nav-btn" onclick="nav('os')">üìã O.S.</button>
            <button class="nav-btn" onclick="nav('financeiro')">üí∞ FINANCEIRO</button>
            <button class="nav-btn" onclick="nav('admin')">‚öôÔ∏è ADM</button>
        </nav>

        <div class="content">
            <div id="reader"></div>

            <div id="view-os" class="view-section active">
                <div class="card">
                    <h3 id="os-form-title">üìã Nova O.S.</h3>
                    <input type="hidden" id="os-edit-id">
                    <input type="text" id="os-numero" placeholder="N¬∫ da O.S. (Manual)">
                    <input type="text" id="os-cliente" placeholder="Nome / Raz√£o Social">
                    <input type="text" id="os-doc" placeholder="CPF / CNPJ">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="os-cep" placeholder="CEP" onblur="buscarCep()" style="flex:1">
                        <input type="text" id="os-bairro" placeholder="Bairro" style="flex:1">
                    </div>
                    <input type="text" id="os-endereco" placeholder="Endere√ßo Completo">
                    <label>T√©cnico Respons√°vel</label><select id="os-tecnico"></select>
                    <label>Tipo de Servi√ßo</label><select id="os-servico-select"></select>
                    <input type="number" id="os-valor-pagar" placeholder="Valor M√£o de Obra (R$)">
                    <button class="btn btn-blue" id="btn-salvar-os" onclick="criarOS()">CRIAR O.S.</button>
                    <button class="btn btn-orange" id="btn-cancelar-edit" onclick="cancelarEdicaoOS()" style="display:none;">CANCELAR EDI√á√ÉO</button>
                </div>
                <div id="lista-os"></div>
            </div>

            <div id="view-estoque" class="view-section">
                <div class="card"><h3>üè¢ Estoque Central</h3><div id="lista-estoque-central"></div></div>
                <div class="card"><h3>üöö Mala T√©cnico</h3><select id="filtro-tecnico-estoque" onchange="carregarEstoqueVolante(this.value)"></select><div id="lista-estoque-volante"></div></div>
            </div>
            <div id="view-entrada" class="view-section">...</div>
             <div id="view-saida" class="view-section">...</div>
             <div id="view-financeiro" class="view-section">...</div>
             <div id="view-admin" class="view-section">...</div>
        </div>
    </div>

<script>
    // CONFIGURA√á√ÉO FIREBASE E SENHA
    const firebaseConfig = { /* Seus dados do Firebase */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const SENHA_PADRAO = "1503";

    // --- FUN√á√ïES DE O.S. ---

    function buscarCep() {
        const cep = document.getElementById('os-cep').value.replace(/\D/g, '');
        if(cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`).then(r => r.json()).then(d => {
                if(!d.erro) {
                    document.getElementById('os-endereco').value = d.logradouro;
                    document.getElementById('os-bairro').value = d.bairro;
                }
            });
        }
    }

    function criarOS() {
        const idEdicao = document.getElementById('os-edit-id').value;
        const dados = {
            os_numero: document.getElementById('os-numero').value,
            cliente: document.getElementById('os-cliente').value,
            documento: document.getElementById('os-doc').value,
            cep: document.getElementById('os-cep').value,
            bairro: document.getElementById('os-bairro').value,
            endereco: document.getElementById('os-endereco').value,
            tecnico_id: document.getElementById('os-tecnico').value,
            tecnico_nome: document.getElementById('os-tecnico').selectedOptions[0].text,
            servico_tipo: document.getElementById('os-servico-select').value,
            valor_pagar: document.getElementById('os-valor-pagar').value || 0,
            status: idEdicao ? undefined : 'pendente', // N√£o muda status se for edi√ß√£o
            data: Date.now()
        };

        if(idEdicao) {
            db.ref('os/' + idEdicao).update(dados).then(() => {
                alert("O.S. Atualizada!");
                cancelarEdicaoOS();
            });
        } else {
            db.ref('os').push(dados).then(() => {
                alert("O.S. Criada!");
                limparCamposOS();
            });
        }
    }

    function editarOS(id) {
        const senha = prompt("Digite a senha 1503 para EDITAR:");
        if(senha !== SENHA_PADRAO) return alert("Senha incorreta!");

        db.ref('os/' + id).once('value', s => {
            const os = s.val();
            document.getElementById('os-edit-id').value = id;
            document.getElementById('os-numero').value = os.os_numero || '';
            document.getElementById('os-cliente').value = os.cliente;
            document.getElementById('os-doc').value = os.documento || '';
            document.getElementById('os-cep').value = os.cep || '';
            document.getElementById('os-bairro').value = os.bairro || '';
            document.getElementById('os-endereco').value = os.endereco;
            document.getElementById('os-tecnico').value = os.tecnico_id;
            document.getElementById('os-servico-select').value = os.servico_tipo;
            document.getElementById('os-valor-pagar').value = os.valor_pagar;
            
            document.getElementById('os-form-title').innerText = "‚úèÔ∏è Editando O.S. " + (os.os_numero || '');
            document.getElementById('btn-salvar-os').innerText = "SALVAR ALTERA√á√ïES";
            document.getElementById('btn-cancelar-edit').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    function cancelarEdicaoOS() {
        document.getElementById('os-edit-id').value = '';
        limparCamposOS();
        document.getElementById('os-form-title').innerText = "üìã Nova O.S.";
        document.getElementById('btn-salvar-os').innerText = "CRIAR O.S.";
        document.getElementById('btn-cancelar-edit').style.display = "none";
    }

    function limparCamposOS() {
        ['os-numero','os-cliente','os-doc','os-cep','os-bairro','os-endereco','os-valor-pagar'].forEach(id => document.getElementById(id).value = '');
    }

    function carregarListaOS() {
        db.ref('os').on('value', s => {
            const dados = s.val() || {};
            const lista = document.getElementById('lista-os');
            lista.innerHTML = '<h3>Hist√≥rico de O.S.</h3>';
            Object.keys(dados).reverse().forEach(id => {
                const os = dados[id];
                const concluida = os.status === 'concluido';
                lista.innerHTML += `
                    <div class="card os-item ${os.status}">
                        <div style="position:absolute; right:10px; top:10px;">
                            <button class="btn-edit" onclick="editarOS('${id}')">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="solicitarExclusao('os/${id}')">üóëÔ∏è</button>
                        </div>
                        <div class="os-info-box">
                            <span class="badge-tec">${os.tecnico_nome}</span> 
                            <b style="color:var(--accent); margin-left:5px;">${os.servico_tipo}</b>
                        </div>
                        <b>${os.os_numero ? 'N¬∫ ' + os.os_numero : ''} | ${os.cliente}</b><br>
                        <small>${os.endereco} - <b>${os.bairro || 'Sem Bairro'}</b></small>
                        ${!concluida ? `<button class="btn btn-green" onclick="abrirModalBaixa('${id}', ${os.valor_pagar})">BAIXAR</button>` : ''}
                    </div>`;
            });
        });
    }

    // ... (Mantenha o restante das fun√ß√µes de Login, C√¢mera, Estoque e Financeiro do c√≥digo anterior) ...
    // Basta chamar carregarListaOS() no AuthStateChanged.

</script>
</body>
</html>